{%load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-User Video Conference with Host-Only Recording</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body{
            background-image: url("{% static 'images/video.jpg' %}");
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
        }
        .video-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .video-wrapper {
            position: relative;
        }
        video {
            width: 100%;
            border-radius: 8px;
            background-color: #222;
        }
        .participant-name {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
        }
        #whiteboard-container {
            display: none;
            margin-top: 20px;
        }
        #whiteboard {
            border: 1px solid #000;
            width: 100%;
            height: 400px;
            cursor: crosshair;
        }
        #participantsList {
            max-height: 200px;
            overflow-y: auto;
        }
        .recording-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: red;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            display: none;
        }
        .host-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'home' %}">Video Conferencing</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'home' %}">Home</a>
                    </li>
                    <!-- Add more navigation items here -->
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'contact' %}">Contact Us</a>
                    </li>
                    {% if user.is_authenticated %}
                    <li>
                        <form action="{% url 'logout' %}" method="POST" class="logout-form">
                            {% csrf_token %}
                            <button type="submit" class="nav-link">Logout</button>
                        </form>
                    </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'login' %}">Login</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="text-center mt-4">Multi-User Video Conference</h1>
        
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        Participants
                    </div>
                    <div class="card-body">
                        <ul id="participantsList" class="list-group">
                        </ul>
                    </div>
                </div>
                <div class="mt-3">
                    <button id="joinAsHost" class="btn btn-primary btn-block">Join as Host</button>
                    <button id="joinAsUser" class="btn btn-secondary btn-block mt-2">Join as User</button>
                    <button id="leaveCall" class="btn btn-danger btn-block mt-2" disabled>Leave Call</button>
                    <button id="shareScreen" class="btn btn-secondary btn-block mt-2" disabled>Share Screen</button>
                    <button id="toggleWhiteboard" class="btn btn-info btn-block mt-2" disabled>Toggle Whiteboard</button>
                    <button id="startRecording" class="btn btn-warning btn-block mt-2" disabled>Start Recording</button>
                    <button id="stopRecording" class="btn btn-danger btn-block mt-2" disabled>Stop Recording</button>
                </div>
            </div>
            <div class="col-md-9">
                <div id="videoContainer" class="video-container">
                    <!-- Videos will be dynamically added here -->
                </div>
            </div>
        </div>

        <div id="whiteboard-container">
            <h2 class="text-center">Shared Whiteboard</h2>
            <canvas id="whiteboard" width="800" height="600" class="mb-4"></canvas>
            <div class="text-center">
                <button id="clearBoard" class="btn btn-danger">Clear Whiteboard</button>
            </div>
        </div>
    </div>

    <script>
        const videoContainer = document.getElementById('videoContainer');
        const joinAsHostButton = document.getElementById('joinAsHost');
        const joinAsUserButton = document.getElementById('joinAsUser');
        const leaveCallButton = document.getElementById('leaveCall');
        const shareScreenButton = document.getElementById('shareScreen');
        const toggleWhiteboardButton = document.getElementById('toggleWhiteboard');
        const startRecordingButton = document.getElementById('startRecording');
        const stopRecordingButton = document.getElementById('stopRecording');
        const whiteboardContainer = document.getElementById('whiteboard-container');
        const clearBoardButton = document.getElementById('clearBoard');
        const participantsList = document.getElementById('participantsList');
        const canvas = document.getElementById('whiteboard');
        const ctx = canvas.getContext('2d');

        let localStream;
        let localUuid;
        let screenStream;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let mediaRecorder;
        let recordedChunks = [];
        let isHost = false;

        joinAsHostButton.onclick = () => joinCall(true);
        joinAsUserButton.onclick = () => joinCall(false);
        leaveCallButton.onclick = leaveCall;
        shareScreenButton.onclick = shareScreen;
        toggleWhiteboardButton.onclick = toggleWhiteboard;
        clearBoardButton.onclick = clearBoard;
        startRecordingButton.onclick = startRecording;
        stopRecordingButton.onclick = stopRecording;

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        async function joinCall(asHost) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localUuid = generateUuid();
                isHost = asHost;
                
                addVideoStream(localUuid, localStream, true, asHost ? "Host" : "You");
                
                joinAsHostButton.disabled = true;
                joinAsUserButton.disabled = true;
                leaveCallButton.disabled = false;
                shareScreenButton.disabled = false;
                toggleWhiteboardButton.disabled = false;
                startRecordingButton.disabled = !asHost;
                
                if (!asHost) {
                    simulateHostJoin();
                }
                simulateUserJoin();
            } catch (err) {
                console.error('Error joining call:', err);
                alert('Failed to access camera and microphone');
            }
        }

        function leaveCall() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                stopRecording();
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            
            videoContainer.innerHTML = '';
            participantsList.innerHTML = '';
            
            joinAsHostButton.disabled = false;
            joinAsUserButton.disabled = false;
            leaveCallButton.disabled = true;
            shareScreenButton.disabled = true;
            toggleWhiteboardButton.disabled = true;
            startRecordingButton.disabled = true;
            stopRecordingButton.disabled = true;
            whiteboardContainer.style.display = 'none';
            isHost = false;
        }

        function toggleWhiteboard() {
            whiteboardContainer.style.display = 
                whiteboardContainer.style.display === 'none' ? 'block' : 'none';
            if (whiteboardContainer.style.display === 'block') {
                resizeCanvas();
            }
        }

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }

        async function shareScreen() {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const videoTrack = screenStream.getVideoTracks()[0];
                
                const localVideo = document.querySelector(`[data-uuid="${localUuid}"]`);
                if (localVideo) {
                    localVideo.srcObject = screenStream;
                }

                videoTrack.onended = () => {
                    if (localVideo) {
                        localVideo.srcObject = localStream;
                    }
                };
            } catch (err) {
                console.error('Error sharing screen:', err);
            }
        }

        function addVideoStream(uuid, stream, isLocal = false, name = null) {
            const videoWrapper = document.createElement('div');
            videoWrapper.className = 'video-wrapper';
            
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.setAttribute('data-uuid', uuid);
            if (isLocal) video.muted = true;
            
            const nameTag = document.createElement('div');
            nameTag.className = 'participant-name';
            nameTag.textContent = name || `User ${uuid.slice(0, 4)}`;
            
            videoWrapper.appendChild(video);
            videoWrapper.appendChild(nameTag);

            if (name === "Host") {
                const hostLabel = document.createElement('div');
                hostLabel.className = 'host-label';
                hostLabel.textContent = 'Host';
                videoWrapper.appendChild(hostLabel);
            }

            videoContainer.appendChild(videoWrapper);

            const listItem = document.createElement('li');
            listItem.className = 'list-group-item';
            listItem.textContent = name || `User ${uuid.slice(0, 4)}`;
            listItem.setAttribute('data-uuid', uuid);
            participantsList.appendChild(listItem);
        }

        function simulateHostJoin() {
            const uuid = generateUuid();
            const dummyStream = createDummyStream("Host");
            addVideoStream(uuid, dummyStream, false, "Host");
        }

        function simulateUserJoin() {
            const uuid = generateUuid();
            const dummyStream = createDummyStream("User");
            addVideoStream(uuid, dummyStream, false, "User");
        }

        function createDummyStream(name) {
            const dummyCanvas = document.createElement('canvas');
            dummyCanvas.width = 640;
            dummyCanvas.height = 480;
            const ctx = dummyCanvas.getContext('2d');
            
            ctx.fillStyle = getRandomColor();
            ctx.fillRect(0, 0, dummyCanvas.width, dummyCanvas.height);
            ctx.fillStyle = 'white';
            ctx.font = '48px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(name, dummyCanvas.width/2, dummyCanvas.height/2);
            
            return dummyCanvas.captureStream();
        }

        function startRecording() {
            if (!isHost) return;

            const hostVideo = document.querySelector('video[data-uuid="' + localUuid + '"]');
            if (!hostVideo) {
                console.error('Host video not found');
                return;
            }

            mediaRecorder = new MediaRecorder(hostVideo.srcObject);

            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'host-recording.webm';
                a.click();
                URL.revokeObjectURL(url);
                recordedChunks = [];
            };

            mediaRecorder.start();
            startRecordingButton.disabled = true;
            stopRecordingButton.disabled = false;

            const recordingIndicator = document.createElement('div');
            recordingIndicator.className = 'recording-indicator';
            recordingIndicator.textContent = 'REC';
            recordingIndicator.style.display = 'block';
            hostVideo.parentElement.appendChild(recordingIndicator);
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                startRecordingButton.disabled = false;
                stopRecordingButton.disabled = true;

                const recordingIndicator = document.querySelector('.recording-indicator');
                if (recordingIndicator) {
                    recordingIndicator.remove();
                }
            }
        }

        function getRandomColor() {
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#1abc9c'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function draw(e) {
            if (!isDrawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearBoard() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function generateUuid() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        window.addEventListener('resize', resizeCanvas);
    </script>
</body>
</html>